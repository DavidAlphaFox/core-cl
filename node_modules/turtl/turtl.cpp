#include <node.h>
#include "nan.h"
#include "turtl.h"
#include "msg.h"

using namespace v8;

#ifndef TURTL_NW
	#define TURTL_NW 0
#endif

/**
 * Load and start our lisp app, synchronously.
 */
NAN_METHOD(start_lisp) {
	NanScope();

	FILE *fp;

	// do some logging because NW on windows not only eats STDOUT, it mkes lisp
	// go batshit insane when trying to print to STDOUT. we need this log to
	// see what weird things happen under the hood.
	fp = fopen("./nw.log", "w");
	fprintf(fp, "log init\n");
	init_messaging();
	fprintf(fp, "messaging init\n");
	int init = turtl_init(TURTL_NW);
	if(init == 0)
	{
		fprintf(fp, "turtl: init done\n");
	}
	else
	{
		fprintf(fp, "turtl: init fail: %s\n", turtl_get_last_error());
	}
	fclose(fp);

	NanReturnUndefined();
}

/**
 * End/shutdown lisp
 */
NAN_METHOD(stop_lisp) {
	NanScope();
	turtl_shutdown();
	NanReturnUndefined();
}

void RegisterModule(Handle<Object> exports)
{
	exports->Set(NanSymbol("start"),
			FunctionTemplate::New(start_lisp)->GetFunction());
	exports->Set(NanSymbol("stop"),
			FunctionTemplate::New(stop_lisp)->GetFunction());
	exports->Set(NanSymbol("set_msg_callback"),
			FunctionTemplate::New(set_msg_callback)->GetFunction());
	exports->Set(NanSymbol("send_msg_lisp"),
			FunctionTemplate::New(send_msg_lisp)->GetFunction());
}

NODE_MODULE(turtl, RegisterModule);

